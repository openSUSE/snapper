#
# spec file for package snapper
#
# Copyright (c) 2016 SUSE LINUX GmbH, Nuernberg, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.

# Please submit bugfixes or comments via http://bugs.opensuse.org/
#


Name:           snapper
Version:        @VERSION@
Release:        0
Summary:        Tool for filesystem snapshot management
License:        GPL-2.0
Group:          System/Packages
Url:            http://snapper.io/
Source:         snapper-%{version}.tar.bz2
BuildRequires:  boost-devel
BuildRequires:  docbook-xsl-stylesheets
BuildRequires:  e2fsprogs-devel
BuildRequires:  gcc-c++
BuildRequires:  libacl-devel
BuildRequires:  libtool
BuildRequires:  libxslt
BuildRequires:  pam-devel
BuildRequires:  pkgconfig
BuildRequires:  pkgconfig(dbus-1)
BuildRequires:  pkgconfig(libxml-2.0)
Requires:       diffutils
Requires:       libsnapper@LIBVERSION_MAJOR@ = %{version}
Recommends:     cron
Recommends:     logrotate
Recommends:     snapper-zypp-plugin
Supplements:    btrfsprogs
BuildRoot:      %{_tmppath}/%{name}-%{version}-build
%if 0%{?suse_version} > 1230
BuildRequires:  libbtrfs-devel
%endif
%if 0%{?suse_version} > 1310
BuildRequires:  pkgconfig
BuildRequires:  pkgconfig(mount) >= 2.24
%endif
%if 0%{?suse_version} >= 1210
BuildRequires:  libzypp(plugin:commit)
%endif

%description
This package contains snapper, a tool for filesystem snapshot management.

%package -n snapper-config
Summary:        Configuration files for snapper
Group:          System/Configuration
Conflicts:      libsnapper1
Conflicts:      libsnapper2
Conflicts:      libsnapper3 < %{version}
Requires(post): %fillup_prereq

%description -n snapper-config
This package contains snapper configuration files and templates.

%package -n libsnapper@LIBVERSION_MAJOR@
Summary:        Library for filesystem snapshot management
Group:          System/Libraries
Requires:       snapper-config
Requires:       util-linux
# expands to Obsoletes: libsnapper1 libsnapper2 libsnapper3...
Obsoletes:      %(echo `seq -s " " -f "libsnapper%.f" $((@LIBVERSION_MAJOR@ - 1))`)

%description -n libsnapper@LIBVERSION_MAJOR@
This package contains libsnapper, a library for filesystem snapshot management.

%package -n libsnapper-devel
Summary:        Header files and documentation for libsnapper
Group:          Development/Languages/C and C++
Requires:       boost-devel
Requires:       gcc-c++
Requires:       libacl-devel
Requires:       libsnapper@LIBVERSION_MAJOR@ = %{version}
Requires:       libstdc++-devel
Requires:       pkgconfig
Requires:       pkgconfig(libxml-2.0)
%if 0%{?suse_version} > 1230
Requires:       libbtrfs-devel
%endif
%if 0%{?suse_version} > 1310
Requires:       pkgconfig
Requires:       pkgconfig(mount) >= 2.24
%endif

%description -n libsnapper-devel
This package contains header files and documentation for developing with
libsnapper.

%package -n snapper-zypp-plugin
Summary:        A zypp commit plugin for calling snapper
Group:          System/Packages
Requires:       dbus-1-python
Requires:       libzypp(plugin:commit) = 1
Requires:       python-xml
Requires:       snapper = %{version}
Requires:       zypp-plugin-python
BuildArch:      noarch

%description -n snapper-zypp-plugin
This package contains a plugin for zypp that makes filesystem snapshots with
snapper during commits.

%package -n pam_snapper
Summary:        PAM module for calling snapper
Group:          System/Packages
Requires:       pam
Requires:       snapper = %{version}

%description -n pam_snapper
A PAM module for calling snapper during user login and logout.

%prep
%setup -q -n snapper-%{version}

%build
export CFLAGS="%{optflags} -DNDEBUG"
export CXXFLAGS="%{optflags} -DNDEBUG"

autoreconf -fiv

%configure --docdir=%{_docdir}/snapper \
%if 0%{?suse_version} <= 1310
	--disable-rollback \
%endif
	--disable-silent-rules --disable-ext4
make %{?_smp_mflags}

%install
make %{?_smp_mflags} DESTDIR=%{buildroot} install
rm %{buildroot}/%{_lib}/security/pam_snapper.la
rm %{buildroot}/%{_libdir}/libsnapper.la

install -D -m 644 data/sysconfig.snapper %{buildroot}%{_localstatedir}/adm/fillup-templates/sysconfig.snapper

ln -s service %{buildroot}/%{_sbindir}/rcsnapper-cleanup
ln -s service %{buildroot}/%{_sbindir}/rcsnapper-timeline

%find_lang snapper

%check
make %{?_smp_mflags} check

%pre
%service_add_pre snapper-timeline.service snapper-cleanup.service

%post
%service_add_post snapper-timeline.service snapper-cleanup.service

%preun
%service_del_preun snapper-timeline.service snapper-cleanup.service

%postun
%service_del_postun snapper-timeline.service snapper-cleanup.service

%files -f snapper.lang
%defattr(-,root,root)
%{_bindir}/snapper
%{_sbindir}/snapperd
%{_sbindir}/mksubvolume
%{_sbindir}/rcsnapper-cleanup
%{_sbindir}/rcsnapper-timeline
%{_prefix}/lib/snapper
%{_mandir}/*/snapper.8*
%{_mandir}/*/snapperd.8*
%{_mandir}/*/snapper-configs.5*
%{_mandir}/*/mksubvolume.8*
%config(noreplace) %{_sysconfdir}/logrotate.d/snapper
%{_sysconfdir}/cron.hourly/suse.de-snapper
%{_sysconfdir}/cron.daily/suse.de-snapper
%{_prefix}/lib/systemd/system/snapper-*.*
%config %{_sysconfdir}/dbus-1/system.d/org.opensuse.Snapper.conf
%{_datadir}/dbus-1/system-services/org.opensuse.Snapper.service

%post -n snapper-config
%{fillup_only -n snapper}

%files -n snapper-config
%dir %{_sysconfdir}/snapper
%dir %{_sysconfdir}/snapper/configs
%dir %{_sysconfdir}/snapper/config-templates
%config(noreplace) %{_sysconfdir}/snapper/config-templates/default
%dir %{_sysconfdir}/snapper/filters
%config(noreplace) %{_sysconfdir}/snapper/filters/*.txt
%doc %dir %{_docdir}/snapper
%doc %{_docdir}/snapper/AUTHORS
%doc %{_docdir}/snapper/COPYING
%{_localstatedir}/adm/fillup-templates/sysconfig.snapper

%post -n libsnapper@LIBVERSION_MAJOR@ -p /sbin/ldconfig
%postun -n libsnapper@LIBVERSION_MAJOR@ -p /sbin/ldconfig

%files -n libsnapper@LIBVERSION_MAJOR@
%defattr(-,root,root)
%{_libdir}/libsnapper.so.*

%files -n libsnapper-devel
%defattr(-,root,root)
%{_libdir}/libsnapper.so
%{_includedir}/snapper

%files -n snapper-zypp-plugin
%defattr(-,root,root)
%config(noreplace) %{_sysconfdir}/snapper/zypp-plugin.conf
%if 0%{?suse_version} < 1210
%dir %{_prefix}/lib/zypp
%dir %{_prefix}/lib/zypp/plugins
%dir %{_prefix}/lib/zypp/plugins/commit
%endif
%{_prefix}/lib/zypp/plugins/commit/snapper.py*
%{_mandir}/*/snapper-zypp-plugin.8*
%{_mandir}/*/snapper-zypp-plugin.conf.5*

%files -n pam_snapper
%defattr(-,root,root)
/%{_lib}/security/pam_snapper.so
%dir %{_prefix}/lib/pam_snapper
%{_prefix}/lib/pam_snapper/*.sh
%{_mandir}/*/pam_snapper.8*

%changelog
